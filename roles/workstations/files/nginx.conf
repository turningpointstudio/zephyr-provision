events {
    worker_connections 1024;
}

http {
    # Map tenant ID from URL path to backend port
    # Extract tenant ID from /<tenant-id>/renders and route to correct instance
    map $request_uri $backend_port {
        default                                         "";

        # Instance 1 - Add your tenant ID here
        ~^/c2ab0e11c166522497a337b215cc3bab/           "3002";

        # Instance 2 - Add tenant ID when configured
        # ~^/TENANT_ID_2/                               "3003";

        # Instance 3 - Add tenant ID when configured
        # ~^/TENANT_ID_3/                               "3004";

        # Instance 4 - Add tenant ID when configured
        # ~^/TENANT_ID_4/                               "3005";

        # Instance 5 - Add tenant ID when configured
        # ~^/TENANT_ID_5/                               "3006";

        # Instance 6 - Add tenant ID when configured
        # ~^/TENANT_ID_6/                               "3007";

        # Instance 7 - Add tenant ID when configured
        # ~^/TENANT_ID_7/                               "3008";

        # Instance 8 - Add tenant ID when configured
        # ~^/TENANT_ID_8/                               "3009";
    }

    # Define individual upstreams for each instance
    upstream instance_3002 { server host.docker.internal:3002 max_fails=3 fail_timeout=30s; }
    upstream instance_3003 { server host.docker.internal:3003 max_fails=3 fail_timeout=30s; }
    upstream instance_3004 { server host.docker.internal:3004 max_fails=3 fail_timeout=30s; }
    upstream instance_3005 { server host.docker.internal:3005 max_fails=3 fail_timeout=30s; }
    upstream instance_3006 { server host.docker.internal:3006 max_fails=3 fail_timeout=30s; }
    upstream instance_3007 { server host.docker.internal:3007 max_fails=3 fail_timeout=30s; }
    upstream instance_3008 { server host.docker.internal:3008 max_fails=3 fail_timeout=30s; }
    upstream instance_3009 { server host.docker.internal:3009 max_fails=3 fail_timeout=30s; }

    server {
        listen 80;

        # Route /<tenant-id>/renders to correct instance based on tenant ID
        location ~ ^/[a-zA-Z0-9]+/renders$ {
            # Check if we have a backend for this tenant
            if ($backend_port = "") {
                return 404 "Unknown tenant ID\n";
            }

            # Rewrite to strip tenant ID from path
            rewrite ^/[a-zA-Z0-9]+/(.*)$ /$1 break;

            # Proxy to the correct instance based on tenant ID
            proxy_pass http://instance_$backend_port;
            proxy_http_version 1.1;

            # Pass original client information
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            # Disable buffering for real-time responses
            proxy_buffering off;
        }

        # Health check endpoint
        location /nginx-health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Default - return 404 for unknown routes
        location / {
            return 404 "Invalid endpoint\n";
        }
    }

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
}
